generate_pr() {
    local BRANCH_NAME_FROM_CLI=""
    local USE_CURRENT_BRANCH=false

    # –ü–∞—Ä—Å–∏–Ω–≥ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    while getopts "b:c" opt; do
        case "$opt" in
            b)
                BRANCH_NAME_FROM_CLI="$OPTARG"
                ;;
            c)
                USE_CURRENT_BRANCH=true
                ;;
            *)
                echo "Usage: generate_pr [-b branch-name] [-c]"
                return 1
                ;;
        esac
    done

    if [ -n "$BRANCH_NAME_FROM_CLI" ] && [ "$USE_CURRENT_BRANCH" = true ]; then
        echo "Error: -b and -c cannot be used together"
        return 1
    fi

    # 0. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è gh
    if ! command -v gh &> /dev/null; then
        echo "Error: GitHub CLI (gh) is not installed."
        return 1
    fi

    git add .

    DIFF=$(git diff --cached)
    if [ -z "$DIFF" ]; then
        echo "No staged changes found. Please stage your changes first using 'git add'"
        return 1
    fi

    echo "ü§ñ Analyzing changes..."

    # 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ—Ç–∫—É
    if [ "$USE_CURRENT_BRANCH" = true ]; then
        BRANCH_NAME=$(git branch --show-current)

        if [ -z "$BRANCH_NAME" ]; then
            echo "Error: could not determine current branch"
            return 1
        fi

        echo "üåø Using current branch: $BRANCH_NAME"

    else
        if [ -n "$BRANCH_NAME_FROM_CLI" ]; then
            BRANCH_NAME="$BRANCH_NAME_FROM_CLI"
            echo "üåø Using branch from CLI: $BRANCH_NAME"
        else
            BRANCH_NAME=$(echo "$DIFF" | llm -x -m gemma \
                "Generate a short, concise git branch name using kebab-case based on these changes. Output ONLY the branch name, no markdown, no explanations.")

            BRANCH_NAME=$(echo "$BRANCH_NAME" | tr -d '[:space:]"`')

            if [ -z "$BRANCH_NAME" ]; then
                echo "Failed to generate branch name"
                return 1
            fi

            echo "üåø Generated branch: $BRANCH_NAME"
        fi

        git checkout -b "$BRANCH_NAME"
    fi

    # 2. –ö–æ–º–º–∏—Ç-–º–µ—Å—Å–µ–¥–∂
    COMMIT_MSG=$(echo "$DIFF" | llm -x -m gemma \
        "Generate a concise commit message (first line) and detailed description (separated by blank line) based on these changes.")

    if [ -z "$COMMIT_MSG" ]; then
        echo "Failed to generate commit message"
        return 1
    fi

    # 3. –ö–æ–º–º–∏—Ç
    git commit -m "$COMMIT_MSG"

    # 4. –ü—É—à
    echo "üöÄ Pushing branch..."
    git push -u origin "$BRANCH_NAME"

    # 5. PR
    PR_TITLE=$(echo "$COMMIT_MSG" | head -n 1)
    PR_BODY=$(echo "$COMMIT_MSG" | tail -n +3)

    echo "üîó Creating Pull Request..."
    gh pr create --title "$PR_TITLE" --body "$PR_BODY" --web
}

generate_pr