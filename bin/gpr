generate_pr() {
    local BRANCH_NAME_FROM_CLI=""
    local USE_CURRENT_BRANCH=false

    ############################
    # helpers
    ############################
    normalize_branch_name() {
        local name="$1"

        name=$(echo "$name" | tr '[:upper:]' '[:lower:]')
        name=$(echo "$name" | sed -E 's/^(feat|fix|chore|refactor|docs|test|style|perf)(\(.+\))?:?//')
        name=$(echo "$name" | sed -E 's/[^a-z0-9]+/-/g')
        name=$(echo "$name" | sed -E 's/^-+//; s/-+$//')
        name=$(echo "$name" | sed -E 's/-{2,}/-/g')
        name=$(echo "$name" | cut -c1-80)

        echo "$name"
    }

    ############################
    # args
    ############################
    while getopts "b:c" opt; do
        case "$opt" in
            b) BRANCH_NAME_FROM_CLI="$OPTARG" ;;
            c) USE_CURRENT_BRANCH=true ;;
            *)
                echo "Usage: generate_pr [-b branch-name] [-c]"
                return 1
                ;;
        esac
    done

    if [ -n "$BRANCH_NAME_FROM_CLI" ] && [ "$USE_CURRENT_BRANCH" = true ]; then
        echo "Error: -b and -c cannot be used together"
        return 1
    fi

    ############################
    # checks
    ############################
    if ! command -v gh &>/dev/null; then
        echo "Error: GitHub CLI (gh) is not installed"
        return 1
    fi

    git add .

    DIFF=$(git diff --cached)
    if [ -z "$DIFF" ]; then
        echo "No staged changes found. Use 'git add' first."
        return 1
    fi

    echo "ü§ñ Analyzing changes..."

    ############################
    # branch logic
    ############################
    if [ "$USE_CURRENT_BRANCH" = true ]; then
        BRANCH_NAME=$(git branch --show-current)

        if [ -z "$BRANCH_NAME" ]; then
            echo "Error: unable to detect current branch"
            return 1
        fi

        if [ "$BRANCH_NAME" = "main" ] || [ "$BRANCH_NAME" = "master" ]; then
            echo "Error: refusing to create PR from '$BRANCH_NAME'"
            return 1
        fi

        echo "üåø Using current branch: $BRANCH_NAME"

    else
        if [ -n "$BRANCH_NAME_FROM_CLI" ]; then
            RAW_BRANCH_NAME="$BRANCH_NAME_FROM_CLI"
            echo "üåø Using branch from CLI: $RAW_BRANCH_NAME"
        else
            RAW_BRANCH_NAME=$(echo "$DIFF" | llm -m gemini \
                "Generate a short, concise git branch name using kebab-case based on these changes. Output ONLY the branch name, no markdown, no explanations.")
            echo "ü§ñ LLM raw branch: $RAW_BRANCH_NAME"
        fi

        BRANCH_NAME=$(normalize_branch_name "$RAW_BRANCH_NAME")

        if ! git check-ref-format "refs/heads/$BRANCH_NAME"; then
            echo "‚ö†Ô∏è Invalid branch name after normalization: $BRANCH_NAME"
            BRANCH_NAME="wip/$(date +%s)"
            echo "‚û°Ô∏è Fallback branch: $BRANCH_NAME"
        fi

        echo "üåø Creating branch: $BRANCH_NAME"
        git checkout -b "$BRANCH_NAME"
    fi

    ############################
    # commit
    ############################
    COMMIT_MSG=$(echo "$DIFF" | llm -m gemini \
        "Generate a concise commit message (first line) and detailed description (separated by blank line) based on these changes.")

    if [ -z "$COMMIT_MSG" ]; then
        echo "Failed to generate commit message"
        return 1
    fi

    git commit -m "$COMMIT_MSG"

    ############################
    # push
    ############################
    echo "üöÄ Pushing branch..."
    git push -u origin "$BRANCH_NAME"

    ############################
    # PR
    ############################
    PR_TITLE=$(echo "$COMMIT_MSG" | head -n 1)
    PR_BODY=$(echo "$COMMIT_MSG" | tail -n +3)

    echo "üîó Creating Pull Request..."
    gh pr create --title "$PR_TITLE" --body "$PR_BODY" --web
}

generate_pr