#!/usr/bin/env bash

set -e

echo "üîÑ Fetching all branches..."
git fetch --all --prune

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–ª–∞–≤–Ω—É—é –≤–µ—Ç–∫—É
MAIN_BRANCH=""
if git show-ref --quiet refs/heads/main; then
    MAIN_BRANCH="main"
elif git show-ref --quiet refs/heads/master; then
    MAIN_BRANCH="master"
else
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é –≤–µ—Ç–∫—É (main/master)."
    exit 1
fi

echo "‚û° Switching to $MAIN_BRANCH..."
git checkout "$MAIN_BRANCH"

echo "üìã –ú–µ—Ä–∂–µ–Ω–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –≤–µ—Ç–∫–∏:"
MERGED_BRANCHES=$(git branch --merged | grep -v "$MAIN_BRANCH" || true)

if [[ -z "$MERGED_BRANCHES" ]]; then
    echo "‚ÑπÔ∏è –ù–µ—Ç –º–µ—Ä–∂–µ–Ω–Ω—ã—Ö –≤–µ—Ç–æ–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è."
else
    echo "$MERGED_BRANCHES"
    echo
    read -r -p "‚ùì –£–¥–∞–ª–∏—Ç—å —ç—Ç–∏ –≤–µ—Ç–∫–∏? –í–≤–µ–¥–∏—Ç–µ 'yes' –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: " CONFIRM

    if [[ "$CONFIRM" == "yes" ]]; then
        echo "üßπ Removing merged local branches..."
        echo "$MERGED_BRANCHES" | xargs -r git branch -d
    else
        echo "üö´ –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ."
    fi
fi

echo "üóë Cleaning remote tracking branches..."
git remote prune origin

echo "‚úÖ Done!"

